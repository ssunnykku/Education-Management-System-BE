<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <script src="https://code.jquery.com/jquery-3.7.1.slim.js"
            integrity="sha256-UgvvN8vBkgO0luPSUl2s8TIlOSYRoGFAX4jlCIm9Adc=" crossorigin="anonymous"></script>
    <title>Document</title>
    <link rel="stylesheet" href="../../css/format.css"/>
    <link rel="stylesheet" href="../../css/students.css"/>
    <link rel="stylesheet" href="../../css/scholarships.css" />
    <style>
        .page-link {
            width: 10px;
        }
    </style>
</head>
<body id="content-wrapper">
<div th:insert="~{common/header :: header}"></div>
<div th:insert="~{common/title :: title ('출결 조회')}"></div>
<section id="attendance-contents">
    <article class="attendance-search-btn-wrapper">
        <div class="attendance-search-form-wrapper">
            <div id="search-form">
                <input placeholder="기수" id="input-course-number" class="courseId-filter" name="courseNumber"/>
                <input placeholder="수강생을 입력하세요" id="input-name" class="search-input" name="name"/>
                <button type="button" class="filter-search-btn">검색</button>
            </div>
        </div>
    </article>
    <section id="content-section">
        <article id="attendance-content-article" style="padding-left: 70px; margin-left: 0;">
            <div class="student-cnt-pages" style="margin-left: 0"></div>
        </article>
        <article>
            <div class="board-table">
                <div class="board-row" id="board-title-row">
                    <div class="attendance-courseId">
                        <span>기수</span>
                    </div>
                    <div class="attendance-name">
                        <span>이름</span>
                    </div>
                    <div class="attendance-birth">
                        <span>생년월일</span>
                    </div>
                    <div class="attendance-duration">
                        <span>과정 기간(일)</span>
                    </div>
                    <div class="attendance-cnt">
                        <span>출석(일)</span>
                    </div>
                    <div class="attendance-cnt-late">
                        <span>지각</span>
                    </div>
                    <div class="attendance-cnt-early-leave">
                        <span>조퇴</span>
                    </div>
                    <div class="attendance-cnt-go-out">
                        <span>외출</span>
                    </div>
                    <div class="attendance-cnt-absence">
                        <span>결석(일)</span>
                    </div>
                    <div class="attendance-total">
                        <span>출석 인정일</span>
                    </div>
                </div>
                <div id="attendance-row-wrapper"></div>
            </div>
        </article>
    </section>
    <article class="page-information">
        <ul id="pagination" style="margin-top: 35px;">
            <li>
                <a class="page-link" id="prev">이전</a>
            </li>
            <li id="page-number" class="page-item" style="display: flex; gap: 20px"></li>
            <li class="page-item">
                <a id="next" class="page-link">다음</a>
            </li>
        </ul>
    </article>
</section>

<footer></footer>
<script>
    let totalPage = 0;
    let currentPage = 1;
    let currentBlock = 1;
    const pageSize = 10;
    const page = new URL(location.href).search.split("=")[0];

    function getCourseNumber() {
        if($("#input-course-number").val() == "") {
            return -1;
        }
        return parseInt($(".courseId-filter").val());
    }
    function getStudentName() {
        return $(".search-input").val();
    }

    // 검색한 출결 데이터 목록 가져오기
    async function getAttendanceList(data) {
        let result = '';
        for(let i= 0; i < data.length; i++) {
            result +=
                `<div class="board-row">
                        <div class="attendance-courseId">
                            <span class="span-course-number">${data[i].courseNumber}</span>
                        </div>
                        <div class="attendance-name">
                            <span clss="span-student-ame">${data[i].name}</span>
                        </div>
                        <div class="attendance-hrdNetId">
                            <span class="span-hrd-net-id">${data[i].hrdNetId}</span>
                        </div>
                        <div class="attendance-duration">
                            <span class="span-attendance-duration">${data[i].totalTrainingDays}</span>
                        </div>
                        <div class="attendance-cnt">
                            <span class="span-attendance-cnt">${data[i].sumAttendance}</span>
                        </div>
                        <div class="attendance-cnt-late">
                            <span class="span-attendance-cnt-late">${data[i].sumLateness}</span>
                        </div>
                        <div class="attendance-cnt-early-leave">
                            <span class="span-attendance-cnt-early-leave">${data[i].sumEarlyLeave}</span>
                        </div>
                        <div class="attendance-cnt-go-out">
                            <span class="span-attendance-cnt-go-out">${data[i].sumGoOut}</span>
                        </div>
                        <div class="attendance-cnt-absence">
                            <span class="span-attendance-cnt-absence">${data[i].sumAbsence}</span>
                        </div>
                        <div class="attendance-cnt-acknowledge">
                            <span class="span-attendance-cnt-acknowledge">${data[i].sumAcknowledge}</span>
                        </div>
                    </div>`;
        }
        $("#attendance-row-wrapper").html("");
        $("#attendance-row-wrapper").append(result);
    };
    // 검색한 출결 데이터 목록 개수 가져오기
    async function getAmountAttendanceList(data) {
        totalPage = Math.ceil(data/2); // 페이징 확인을 위해 '2'로 해둔 것. 10으로 바꿔야함.

        let result = '';
        result += `<span class="span-attendance-list-amount">총 ${data}건</span>`;
        $(".student-cnt-pages").html("");
        $(".student-cnt-pages").append(result);

        await updatePagination();
    };

    async function fetchStudentAttendanceList(param) {
        const myHeaders = new Headers();
        myHeaders.append("Content-Type", "application/json");

        const raw = JSON.stringify({
            "name": getStudentName(),
            "courseNumber": getCourseNumber()
        });

        const requestOptions = {
            method: "POST",
            headers: myHeaders,
            body: raw,
            redirect: "follow"
        };

        // await fetch("/attendances/student-list?courseNumber="+getCourseNumber()+"&name="+getStudentName()+"&page="+clickPage, requestOptions)
        await fetch("/attendances/student-list?page="+param, requestOptions)
                .then((res) => res.json())
            .then(async(data) => {
                let attendanceList = data.attendanceList;

                let amount = data.amount;
                await getAttendanceList(attendanceList);
                await getAmountAttendanceList(amount);
            })
            .catch((error) => console.error(error));
    };

    $(".filter-search-btn").click(async function() {
        const myHeaders = new Headers();
        myHeaders.append("Content-Type", "application/json");

        const raw = JSON.stringify({
            "name": getStudentName(),
            "courseNumber": getCourseNumber()
        });

        const requestOptions = {
            method: "POST",
            headers: myHeaders,
            body: raw,
            redirect: "follow"
        };

        await fetchStudentAttendanceList(page);
    });

    // 페이지네이션
    function updatePagination() {
        $("#page-number").html("");
        let firstPage = (currentBlock * pageSize) - pageSize + 1;
        let lastPage = totalPage <= currentBlock * pageSize ? totalPage : currentBlock * pageSize;

        for(let i = firstPage; i<= lastPage; i++) {
            let num = i;
            $("#page-number").append(`<a class="page-link" onclick="fetchStudentAttendanceList(${num})">${num}</a>`);
        }
    }

    $("#next").click(() => {
        if(currentBlock * pageSize < totalPage) {
            currentBlock ++;
            currentPage = (currentBlock * pageSize) - pageSize + 1;
            updatePagination();
        }
    });

    $("#prev").click(() => {
        if(currentBlock > 1) {
            currentBlock --;
            currentPage = (currentBlock * pageSize) - pageSize + 1;
            updatePagination();
        }
    });


    /*
    // 출결 조회 의 attendanceRequest용으로 작성
    const attendanceRequest2 = JSON.stringify({
        "attendanceDate": getAttendanceDate(),
        "courseNumber": getCourseNumber(),
        "name": getStudentName()
    });
    */


    /*
    // 출결 조회 에 대한 메서드
    async function searchAttendanceByFilter() {
        try {
            const combinedRequest = JSON.stringify({
                "pageRequest": pageRequest,
                "attendanceRequest": attendanceRequest
            });
            const response = await fetch('/attendances/search-list', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: combinedRequest
            });

            if(response.ok) {
                const responseJSON = await response.json();
                console.log(responseJSON);
            } else {
                console.error("검색 실패: ", response.status);
            }
        } catch(error) {
            console.error("검색 오류: ", error);
        }
    }
    */

    /*
    function handleSearch(event) {
        event.preventDefault();

        const courseNumberInput = document.getElementById("input-course-number");
        const nameInput = document.getElementById("input-name");
        courseNumberInput.value = courseNumberInput.value;
        nameInput.value = nameInput.value;
    }
    */
</script>
</body>
</html>
